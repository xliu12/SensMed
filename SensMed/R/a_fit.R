# prob -----------------

a.c <- function(med, #varnames, cluster_opt = "cwc", bounded = TRUE,
                folds, learners, control, covariates_cl = FALSE) {
    # data_in <- med@data
    a_c <- matrix(nrow = nrow(med@data), ncol = 2)
    colnames(a_c) <- c("a(0|c)", "a(1|c)")

    v <- 1
    for (v in seq_along(folds)) {
        # train <- origami::training(data_in, folds[[v]])
        # valid <- origami::validation(data_in, folds[[v]])
        train <- training(med, folds, v)
        valid <- validation(med, folds, v)

        # alist <- crossfit(train[["data"]], list(valid[["data"]]), varnames$A, c(varnames$X), varnames,
        #                   ipw = NULL,
        #                   cluster_opt,
        #                   type = c("binomial"), learners, bounded)
        # alist$fit$fitLibrary$SL.glm_All$object$coefficients
        # preds <- alist$preds
        vars <- med@vars
        varnames_1 <- c(vars@A, vars@C)
        
        if (covariates_cl) {
            varnames_1 <- na.omit(c(vars@A, glue("{c(vars@A)}_clmean"), glue("{c(vars@C)}_cwc"), vars@Wj))
        }
        
        fit <- mlr3superlearner::mlr3superlearner(
            data = train$data[, varnames_1],
            target = med@vars@A,
            library = learners,
            outcome_type = "binomial",
            folds = control$mlr3superlearner_folds,
            newdata = valid,
            group = NULL,
            discrete = FALSE
        )
        
        a_c[folds[[v]]$validation_set, "a(0|c)"] <- 1 - fit$preds$data #1 - preds[, 1]
        a_c[folds[[v]]$validation_set, "a(1|c)"] <- fit$preds$data # preds[, 1]
    }
    a_c
}





a.mc <- function(med, M, #varnames, cluster_opt = "cwc", bounded = TRUE,
                 folds, learners, control, covariates_cl = FALSE) {
    # data_in <- med@data
    a_mc <- matrix(nrow = nrow(med@data), ncol = 2)
    colnames(a_mc) <- c("a(0|m,c)", "a(1|m,c)")

    vars <- med@vars
    varnames_y <- na.omit(c(vars@A, vars@C, M))
    
    if (covariates_cl) {
        varnames_y <- na.omit(c(c(vars@A), glue("{c(vars@A, M)}_clmean"), glue("{c(vars@C, M)}_cwc"), vars@Wj))
    }
    
    v <- 1
    for (v in seq_along(folds)) {
        # train <- origami::training(data_in, folds[[v]])
        # valid <- origami::validation(data_in, folds[[v]])
        train <- training(med, folds, v)
        valid <- validation(med, folds, v)

        # alist <- crossfit(train[["data"]], list(valid[["data"]]), varnames$A, c(varnames$M, varnames$X), varnames,
        #                   ipw = NULL,
        #                   cluster_opt,
        #                   type = c("binomial"), learners, bounded)
        
        fit <- mlr3superlearner::mlr3superlearner(
            data = train$data[, varnames_y],
            target = med@vars@A,
            library = learners,
            outcome_type = "binomial",
            folds = control$mlr3superlearner_folds,
            newdata = valid,
            group = NULL,
            discrete = FALSE
        )
        
        # alist$fit$fitLibrary$SL.glm_All$object$coefficients
        # preds <- alist$preds
        a_mc[folds[[v]]$validation_set, "a(0|m,c)"] <- 1 - fit$preds$data #1 - preds[, 1]
        a_mc[folds[[v]]$validation_set, "a(1|m,c)"] <- fit$preds$data #preds[, 1]
    }
    a_mc
}

# density ratio

r.zmac <- function(med, permuted, #varnames, cluster_opt = "cwc", bounded = TRUE,
                    folds, learners, control, covariates_cl = FALSE) {
    
    r_zmac <- matrix(NA, nrow = nrow(med@data), ncol = 1)
    colnames(r_zmac) <- "r_zmac"
    # two_sample[["tmp_id"]] <- rep(1:nrow(med@data), times = 2)
    
    v <- 1
    for (v in seq_along(folds)) {
        # train <- origami::training(data_in, folds[[v]])
        # valid <- origami::validation(data_in, folds[[v]])
        train <- training(med, folds, v)
        valid <- validation(med, folds, v)
        
        pseudo <- train$data
        # # P <- linear_permutation(pseudo[, c(med@vars@A, med@vars@C)])
        for (j in permuted) {
            pseudo[, j] <- sample_M(train$data[, j, drop = TRUE])
            # pseudo[, j] <- as.vector(P %*% as.matrix(pseudo[, j]))
        }
        
        # pseudo <- train$data_indepM
        
        stacked_train <- rbind(train$data, pseudo)
        stacked_train[["Lambda"]] <- rep(c(0, 1), each = nrow(train$data))
        
        varnames_azmc <- c("Lambda", med@vars@A, med@vars@M, med@vars@C)
        if (covariates_cl) {
            varnames_azmc <- c("Lambda", med@vars@A, med@vars@M, med@vars@C)
        }
        
        fit_azmc <- mlr3superlearner::mlr3superlearner(
            data = stacked_train[, varnames_azmc],
            target = "Lambda",
            library = learners,
            outcome_type = "binomial",
            folds = control$mlr3superlearner_folds,
            newdata = valid,
            group = NULL,
            discrete = FALSE
        )
        # r_zmac[folds[[v]]$validation_set, "r_zmac"] <- fit_azmc$preds$data / pmax((1 - fit_azmc$preds$data), 0.01)
        
        varnames_amc <- c("Lambda", med@vars@A, permuted, med@vars@C)
        fit_amc <- mlr3superlearner::mlr3superlearner(
            data = stacked_train[, varnames_amc],
            target = "Lambda",
            library = learners,
            outcome_type = "binomial",
            folds = control$mlr3superlearner_folds,
            newdata = valid,
            group = NULL,
            discrete = FALSE
        )
        r_zmac[folds[[v]]$validation_set, "r_zmac"] <- fit_azmc$preds$data * (1 - fit_amc$preds$data) / pmax((1 - fit_azmc$preds$data) * fit_amc$preds$data, 0.001)
        
        
    }
    r_zmac
}

# weights ------------------------------

alpha.ac <- function(A, a_c) {

    # A <- med@data$A
    a_vals <- c(0, 1)

    ipw_a <- lapply(a_vals, \(a) {
        ipwa <- 1*(A==a) / bound(a_c[, glue("a({a}|c)")], tol = 1e-2)
        normalize(ipwa)
        # ipwa
        } )
    names(ipw_a) <- glue("A={a_vals}")
    ipw_a
}

alpha.amc <- function(A, ay, am, a_c, a_mc) {

    h_am <- ( 1*(A==ay) * a_mc[, glue("a({am}|m,c)")] ) /
        pmax(a_c[, glue("a({am}|c)")] * a_mc[, glue("a({ay}|m,c)")], 0.01)

    normalize(h_am)
    # h_am
}



alpha.azmc <- function(A, ay, am, az, a_c, a_mc, a_zc, r_zmac) {
    
    iorw_m <- a_mc[, glue("a({am}|m,c)")] * a_c[, glue("a({ay}|c)")] / pmax(a_mc[, glue("a({ay}|m,c)")] * a_c[, glue("a({am}|c)")], 1e-2)
    iorw_z <- a_zc[, glue("a({az}|m,c)")] * a_c[, glue("a({ay}|c)")] / pmax(a_zc[, glue("a({ay}|m,c)")] * a_c[, glue("a({az}|c)")], 1e-2)
    ipw_a <- 1 * (A == ay) / pmax(a_c[, glue("a({ay}|c)")], 1e-2)
    
    h_azm <- ipw_a * iorw_m * iorw_z * r_zmac 
    # h_azm <- r_zmac * ( 1*(A==ay) * a_mc[, glue("a({am}|m,c)")] * a_zc[, glue("a({az}|m,c)")] )  /
    #     pmax(a_c[, glue("a({ay}|c)")] * a_mc[, glue("a({ay}|m,c)")] * a_zc[, glue("a({ay}|m,c)")], 0.01)
    
    # h_azm
    normalize(h_azm)
}

